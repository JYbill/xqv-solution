<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>è¶…å¤§æ–‡ä»¶ä¸‹è½½HTTP rangeæ–¹æ¡ˆ</title>
</head>
<body>
  <button class="download">ä¸‹è½½è¶…å¤§æ–‡ä»¶</button>

  <script src="https://cdn.jsdelivr.net/npm/streamsaver@2.0.6/StreamSaver.min.js"></script>
  <script>
    class OversizeFileDownloader {
      url;
      limitSize;
      processHandler; // è¿›åº¦é’©å­

      // ä¸‹é¢æ•°æ®ç»“æŸåéœ€è¦é‡ç½®
      isDownload = false; // æ˜¯å¦æ­£åœ¨ä¸‹è½½
      fileTotalSize = 0; // æ€»äºŒè¿›åˆ¶å¤§å°ï¼ˆå­—èŠ‚ï¼‰
      filename = ""; // æ–‡ä»¶å
      bufferPos = 0; // å·²ä¸‹è½½å­—èŠ‚å¤§å°
      constructor(url, processHandler, limitSize = 1024 * 1024 * 1024) {
        if (!url) {
          throw TypeError("url is must")
        }
        this.url = url;
        this.limitSize = limitSize; // é»˜è®¤1G
        if (!processHandler) {
          this.processHandler = function() {
            console.log("progress", (this.bufferPos / this.fileTotalSize * 100).toFixed(2) + "%");
          }
        }
      }

      /**
       * ä¸‹è½½æ ¸å¿ƒå¤„ç†
       * @returns {Promise<void>}
       */
      async downloadCore() {
        if (this.isDownload) {
          console.warn("downloader is running, pls wait 'isDownload = false'");
          return;
        }
        this.isDownload = true;
        console.log("ğŸ˜„ start downloading");

        const res = await this.downloadFile();
        this.filename = res.filename;
        this.fileTotalSize = res.fileTotalSize;
        let {reader} = res;
        const fileStream = streamSaver.createWriteStream(this.filename, { size: this.fileTotalSize })
        const writer = fileStream.getWriter();

        // åˆ†ç‰‡å¾ªç¯ä¸‹è½½
        while (this.bufferPos < this.fileTotalSize) {
          let done = false; // æœ¬æ¬¡HTTP rangeæ˜¯å¦å†™å…¥å®Œæ¯•

          // å¾ªç¯è¯»å–äºŒè¿›åˆ¶å¹¶å†™å…¥writeable stream
          while (!done) {
            const bufferRes = await reader.read();
            const buffer = bufferRes.value;
            done = bufferRes.done;
            if (!done) {
              await writer.ready.then(async () => {
                await writer.write(buffer);
                this.bufferPos += buffer.length;
                this.processHandler.call(this);
              })
            }
          }

          // è·å–ä¸‹ä¸€ä¸ªrangeèŒƒå›´çš„äºŒè¿›åˆ¶æµ
          const retryRes = await this.downloadFile(this.bufferPos);
          reader = retryRes.reader;
        }
        writer.ready.then(() => {
          writer.close();
        })
        writer.closed.then(() => {
          console.log("âœ… ä¸‹è½½å®Œæ¯•");
          this.resetState();
        })
      }

      resetState() {
        this.isDownload = false;
        this.fileTotalSize = 0;
        this.filename = "";
        this.bufferPos = 0;
      }

      /**
       * HTTP Rangeä¸‹è½½æ–‡ä»¶äºŒè¿›åˆ¶
       * @param startPos
       * @returns {Promise<{res: Response, filename: string, size: number, reader: ReadableStreamDefaultReader<R>, fileTotalSize: number, contentLength: number}>}
       */
      async downloadFile(startPos = 0) {
        const endPos = this.limitSize + startPos;
        const res = await fetch(this.url, {
          method: "GET",
          headers: {
            'Range': `bytes=${startPos}-${endPos}`
          }
        })
        let contentDisposition = res.headers.get("Content-Disposition");
        contentDisposition = contentDisposition.split("filename=")[1];
        contentDisposition = contentDisposition.replaceAll(`"`, '');
        const size = Number(res.headers.get("Content-Length"));
        const fileTotalSize = Number(res.headers.get('File-Total-Size'));
        const contentLength = Number(res.headers.get('Content-Length'));
        return {
          res,
          reader: res.body.getReader(),
          filename: contentDisposition,
          size,
          fileTotalSize,
          contentLength
        };
      }
    }
  </script>
  <script>
    const btn = document.querySelector(".download");
    const downloader = new OversizeFileDownloader("/api/");
    btn.addEventListener("click", () => {
      downloader.downloadCore();
    })
  </script>
</body>
</html>
